#!/usr/bin/env bash
set -euo pipefail

# ---- settings ----
LOG="/var/log/remove-media-camera.log"

# Packages: adjust as needed for your desktop environment.
# Rhythmbox
PKGS_RHYTHMBOX=(
  rhythmbox
  rhythmbox-plugins
)

# GNOME Calendar (package name is typically gnome-calendar)
PKGS_CALENDAR=(
  gnome-calendar
)

# Camera apps: GNOME "Cheese" (older) and "Snapshot" (newer).
# Some systems may have one, both, or neither.
PKGS_CAMERA_APPS=(
  cheese
  snapshot
)

# Optional: multimedia stack bits sometimes pulled in by the above
# (remove only if you *really* want them gone).
PKGS_OPTIONAL=(
  # gstreamer1.0-plugins-bad
  # gstreamer1.0-plugins-ugly
)

# Kernel modules to disable/unload for webcam support.
# uvcvideo is the big one for USB webcams; videodev is core V4L2 device node support.
CAMERA_MODULES=(
  uvcvideo
  videodev
  v4l2_common
  v4l2loopback
)

BLACKLIST_FILE="/etc/modprobe.d/blacklist-camera.conf"

# ---- helpers ----
log() {
  echo "[$(date -Is)] $*" | tee -a "$LOG" >&2
}

need_root() {
  if [[ "${EUID}" -ne 0 ]]; then
    echo "Run as root (use sudo): sudo $0" >&2
    exit 1
  fi
}

kill_if_running() {
  local name="$1"
  if pgrep -x "$name" >/dev/null 2>&1; then
    log "Killing process: $name"
    pkill -TERM -x "$name" || true
    sleep 1
    pkill -KILL -x "$name" || true
  else
    log "Process not running: $name"
  fi
}

purge_packages() {
  local -a pkgs=("$@")
  # Only try to purge packages that exist/are installed or known to apt
  # apt will error on unknown names, so we filter by apt-cache.
  local -a existing=()
  for p in "${pkgs[@]}"; do
    if apt-cache show "$p" >/dev/null 2>&1; then
      existing+=("$p")
    else
      log "Package not found in apt cache (skipping): $p"
    fi
  done

  if [[ "${#existing[@]}" -gt 0 ]]; then
    log "Purging packages: ${existing[*]}"
    DEBIAN_FRONTEND=noninteractive apt-get -y purge "${existing[@]}"
  else
    log "No matching packages to purge in this group."
  fi
}

blacklist_camera_modules() {
  log "Writing blacklist file: $BLACKLIST_FILE"
  cat > "$BLACKLIST_FILE" <<'EOF'
# Generated by remove-media-camera.sh
# Disable common webcam/video4linux drivers

blacklist uvcvideo
blacklist videodev
blacklist v4l2_common
blacklist v4l2loopback

# Extra hardening: prevent modprobe from loading even if requested
install uvcvideo /bin/false
install videodev /bin/false
install v4l2_common /bin/false
install v4l2loopback /bin/false
EOF
}

unload_modules_now() {
  log "Attempting to unload camera-related kernel modules (best-effort)."
  for m in "${CAMERA_MODULES[@]}"; do
    if lsmod | awk '{print $1}' | grep -qx "$m"; then
      log "Module loaded, removing: $m"
      modprobe -r "$m" || log "Could not remove $m (may be in use)."
    else
      log "Module not loaded: $m"
    fi
  done
}

main() {
  need_root
  touch "$LOG"
  chmod 600 "$LOG"

  log "=== Starting removal/purge + camera module blacklist ==="

  log "Updating apt metadata"
  apt-get update -y

  # Kill apps if running (names can vary; these are common)
  kill_if_running "rhythmbox"
  kill_if_running "gnome-calendar"
  kill_if_running "cheese"
  kill_if_running "snapshot"

  # Purge packages
  purge_packages "${PKGS_RHYTHMBOX[@]}"
  purge_packages "${PKGS_CALENDAR[@]}"
  purge_packages "${PKGS_CAMERA_APPS[@]}"
  purge_packages "${PKGS_OPTIONAL[@]}"

  log "Autoremoving orphaned dependencies"
  DEBIAN_FRONTEND=noninteractive apt-get -y autoremove --purge

  # Blacklist + unload modules
  blacklist_camera_modules
  unload_modules_now

  log "Updating initramfs so blacklist applies early at boot"
  update-initramfs -u

  log "=== Done. Reboot recommended. Log: $LOG ==="
  log "Reboot with: sudo reboot"
}

main "$@"
